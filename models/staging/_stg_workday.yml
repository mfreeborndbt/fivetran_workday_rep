version: 2

models:
  - name: stg_workday__worker
    description: >
      Staging model for worker data that transforms raw data from the base layer. 
      Key transformations include: (1) Column standardization using fill_staging_columns 
      to ensure all expected columns exist even if missing from source, (2) Column 
      renaming for consistency (e.g., id → worker_id, active → is_active), (3) Fivetran 
      History Mode filtering using _fivetran_start/_fivetran_end to return only the 
      current version of each record. Contains employment status, compensation details, 
      termination information, and worker-level attributes.
    columns:
      - name: worker_id
        description: '{{ doc("worker_id") }}'
        tests:
          - not_null:
              name: stg_worker__worker_id_not_null
      - name: source_relation
        description: '{{ doc("source_relation") }}'
      - name: hire_date
        description: '{{ doc("hire_date") }}'
        tests:
          # Intentionally failing test (as warning) - demonstrates data quality monitoring
          - dbt_expectations.expect_column_values_to_be_between:
              name: warn_hire_date_after_2024
              arguments:
                min_value: "'2024-01-01'"
                max_value: "current_date"
              config:
                severity: warn
                where: "hire_date is not null"
    tests:
      - dbt_utils.unique_combination_of_columns:
          name: stg_worker__unique_worker_source
          arguments:
            combination_of_columns:
              - worker_id
              - source_relation

  - name: stg_workday__worker_position
    description: >
      Staging model for worker position data that transforms raw data from the base layer. 
      Applies column standardization via fill_staging_columns, renames columns for 
      consistency (e.g., business_site_summary_location → position_location), and filters 
      to current records using Fivetran History Mode (_fivetran_start/_fivetran_end). 
      Contains job title, location, employment type, and position-specific details.
    columns:
      - name: worker_id
        description: '{{ doc("worker_id") }}'
        tests:
          - not_null:
              name: stg_worker_position__worker_id_not_null
      - name: position_id
        description: '{{ doc("position_id") }}'
        tests:
          - not_null:
              name: stg_worker_position__position_id_not_null
      - name: source_relation
        description: '{{ doc("source_relation") }}'
    tests:
      - dbt_utils.unique_combination_of_columns:
          name: stg_worker_position__unique_worker_position_source
          arguments:
            combination_of_columns:
              - worker_id
              - position_id
              - source_relation

  - name: stg_workday__personal_information_common_data
    description: >
      Staging model for common personal information that transforms raw data from the 
      base layer. Applies fill_staging_columns for schema flexibility, standardizes 
      column names, and filters to current records. Contains date of birth, nationality, 
      citizenship status, and birth location details.
    columns:
      - name: fivetran_id
        description: '{{ doc("fivetran_id") }}'
        tests:
          - not_null:
              name: stg_personal_info__fivetran_id_not_null
      - name: worker_id
        description: '{{ doc("worker_id") }}'
        tests:
          - not_null:
              name: stg_personal_info__worker_id_not_null
      - name: source_relation
        description: '{{ doc("source_relation") }}'
      - name: date_of_birth
        description: '{{ doc("date_of_birth") }}'
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              name: valid_date_of_birth_range
              arguments:
                min_value: "'1940-01-01'"
                max_value: "'2010-01-01'"
              config:
                where: "date_of_birth is not null"
    tests:
      - dbt_utils.unique_combination_of_columns:
          name: stg_personal_info__unique_fivetran_source
          arguments:
            combination_of_columns:
              - fivetran_id
              - source_relation

  - name: stg_workday__country_personal_information
    description: >
      Staging model for country-specific personal information that transforms raw data 
      from the base layer. Uses fill_staging_columns for schema resilience, standardizes 
      column names, and applies Fivetran History Mode filtering. Contains gender, 
      Hispanic/Latino indicator, and marital status.
    columns:
      - name: fivetran_id
        description: '{{ doc("fivetran_id") }}'
        tests:
          - not_null:
              name: stg_country_personal__fivetran_id_not_null
      - name: personal_info_common_id
        description: Foreign key to personal_information_common_data.
        tests:
          - not_null:
              name: stg_country_personal__personal_info_common_id_not_null
      - name: source_relation
        description: '{{ doc("source_relation") }}'
      - name: gender
        description: '{{ doc("gender") }}'
        tests:
          - dbt_expectations.expect_column_values_to_be_in_set:
              name: valid_gender_values
              arguments:
                value_set: ['Male', 'Female', 'Non-Binary', 'Other', 'Prefer Not to Say']
              config:
                where: "gender is not null"
    tests:
      - dbt_utils.unique_combination_of_columns:
          name: stg_country_personal__unique_fivetran_source
          arguments:
            combination_of_columns:
              - fivetran_id
              - source_relation

  - name: stg_workday__person_name
    description: >
      Staging model for person name data that transforms raw data from the base layer. 
      Applies column standardization and renaming (e.g., type → person_name_type), and 
      filters to current records. Used to get the preferred name for employee displays.
    columns:
      - name: worker_id
        description: '{{ doc("worker_id") }}'
        tests:
          - not_null:
              name: stg_person_name__worker_id_not_null
      - name: source_relation
        description: '{{ doc("source_relation") }}'
      - name: first_name
        description: '{{ doc("first_name") }}'
      - name: last_name
        description: '{{ doc("last_name") }}'
    tests:
      - dbt_utils.unique_combination_of_columns:
          name: stg_person_name__unique_worker_source_type
          arguments:
            combination_of_columns:
              - worker_id
              - source_relation
              - person_name_type

  - name: stg_workday__person_contact_email_address
    description: >
      Staging model for person email addresses that transforms raw data from the base 
      layer. Uses fill_staging_columns for schema flexibility, renames columns (e.g., 
      id → person_contact_email_address_id), and filters to non-deleted records. 
      Contains work and personal email addresses with email type codes.
    columns:
      - name: person_contact_email_address_id
        description: Unique identifier for the email record.
        tests:
          - not_null:
              name: stg_email__email_id_not_null
      - name: worker_id
        description: '{{ doc("worker_id") }}'
        tests:
          - not_null:
              name: stg_email__worker_id_not_null
      - name: source_relation
        description: '{{ doc("source_relation") }}'
      - name: email_address
        description: '{{ doc("email_address") }}'
        tests:
          - dbt_expectations.expect_column_values_to_match_regex:
              name: valid_email_format
              arguments:
                regex: '^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
              config:
                where: "email_address is not null"
    tests:
      - dbt_utils.unique_combination_of_columns:
          name: stg_email__unique_email_source
          arguments:
            combination_of_columns:
              - person_contact_email_address_id
              - source_relation

  - name: stg_workday__personal_information_ethnicity
    description: >
      Staging model for ethnicity information that transforms raw data from the base 
      layer. Applies column standardization and renaming (e.g., id → ethnicity_id), 
      filters to non-deleted records. Ethnicity codes are aggregated at the worker 
      level in downstream intermediate models.
    columns:
      - name: ethnicity_id
        description: Unique identifier for the ethnicity record.
        tests:
          - not_null:
              name: stg_ethnicity__ethnicity_id_not_null
      - name: worker_id
        description: Foreign key linking to country_personal_information.
        tests:
          - not_null:
              name: stg_ethnicity__worker_id_not_null
      - name: source_relation
        description: '{{ doc("source_relation") }}'
    tests:
      - dbt_utils.unique_combination_of_columns:
          name: stg_ethnicity__unique_ethnicity_source
          arguments:
            combination_of_columns:
              - ethnicity_id
              - source_relation

  - name: stg_workday__military_service
    description: >
      Staging model for military service records that transforms raw data from the base 
      layer. Uses fill_staging_columns for schema resilience, standardizes column names, 
      and filters to non-deleted records. Contains service branch, rank, discharge type, 
      and service dates.
    columns:
      - name: worker_id
        description: Foreign key linking to personal_information_common_data.
        tests:
          - not_null:
              name: stg_military__worker_id_not_null
      - name: source_relation
        description: '{{ doc("source_relation") }}'
      - name: military_status
        description: '{{ doc("military_status") }}'
    tests:
      - dbt_utils.unique_combination_of_columns:
          name: stg_military__unique_worker_source
          arguments:
            combination_of_columns:
              - worker_id
              - source_relation
